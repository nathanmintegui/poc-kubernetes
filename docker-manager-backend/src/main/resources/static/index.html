<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Status dos Containers</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #3b82f6;
        }

        .card h2 {
            margin-top: 0;
            font-size: 20px;
            color: #1f2937;
        }

        .card p {
            margin: 5px 0;
            font-size: 14px;
            color: #4b5563;
        }

        .ativo {
            color: green;
            font-weight: bold;
        }

        .inativo {
            color: red;
            font-weight: bold;
        }

        .progress-bar {
            height: 10px;
            border-radius: 5px;
            background-color: #e5e7eb;
            margin-top: 5px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            border-radius: 5px;
            background-color: #3b82f6;
        }

        .label {
            font-size: 12px;
            margin-top: 4px;
            color: #6b7280;
        }

        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 16px;
            margin: 5px 4px 0 0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #2563eb;
        }

        button:active {
            background-color: #1d4ed8;
        }

        .card button {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>Status dos Containers</h1>

<div class="grid" id="containerGrid">
    <p id="loadingMessage">Carregando dados dos containers...</p>
</div>

<button onclick="handleClick()">⚠️ Stress API ⚠️</button>

<script>
    const containerGrid = document.getElementById('containerGrid');
    const loadingMessage = document.getElementById('loadingMessage');

    // Função para exibir mensagem de erro
    function showError(message) {
        containerGrid.innerHTML = `<div class="card" style="grid-column: 1 / -1; background-color: #fee2e2; border-left-color: #ef4444;">
            <h2>Erro na conexão</h2>
            <p>${message}</p>
            <p>Tente recarregar a página.</p>
        </div>`;
    }

    // Função para formatar hora
    function formatHoraMinutoSegundo(dataHora) {
        try {
            const date = new Date(dataHora);
            const horas = String(date.getHours()).padStart(2, '0');
            const minutos = String(date.getMinutes()).padStart(2, '0');
            const segundos = String(date.getSeconds()).padStart(2, '0');
            return `${horas}:${minutos}:${segundos}`;
        } catch (e) {
            return dataHora; // Retorna o valor original se não puder formatar
        }
    }

    function handleClick() {
        fetch("http://localhost:8081/load/start")
            .then(response => {
                if (!response.ok) throw new Error("Erro ao chamar a API");
                return response.json();
            })
            .then(data => {
                if (Array.isArray(data)) {
                    console.log("[INFO]: api response data ", data)
                } else {
                    showError("Resposta inesperada da API.");
                }
            })
            .catch(error => {
                console.error("Erro na chamada da API:", error);
                showError("Erro ao obter dados manualmente da API.");
            });
    }

    /**
     * @param {string} containerId
     */
    function handleStopContainerClick(containerId) {
        console.assert(typeof containerId === "string")
        console.assert(containerId !== "")

        fetch(`http://localhost:8080/api/containers/${containerId}/stop`, {method: 'POST'})
            .then(response => {
                if (!response.ok) throw new Error("Erro ao chamar a API");
            })
            .catch(error => {
                console.error("Erro na chamada da API:", error);
                showError("Erro ao obter dados manualmente da API.");
            });
    }

    /**
     * @param {string} containerId
     */
    function handleStopContainerBruteForceClick(containerId) {
        console.assert(typeof containerId === "string")
        console.assert(containerId !== "")

        fetch(`http://localhost:8080/api/containers/${containerId}/stop-force`, {method: 'POST'})
            .then(response => {
                if (!response.ok) throw new Error("Erro ao chamar a API");
            })
            .catch(error => {
                console.error("Erro na chamada da API:", error);
                showError("Erro ao obter dados manualmente da API.");
            });
    }

    /**
     * @param {string} containerId
     */
    function handleStartContainerClick(containerId) {
        console.assert(typeof containerId === "string")
        console.assert(containerId !== "")

        fetch(`http://localhost:8080/api/containers/${containerId}/start`, {method: 'POST'})
            .then(response => {
                if (!response.ok) throw new Error("Erro ao chamar a API");
            })
            .catch(error => {
                console.error("Erro na chamada da API:", error);
                showError("Erro ao obter dados manualmente da API.");
            });
    }

    // Conecta ao SSE
    function connectSSE() {
        const eventSource = new EventSource("http://localhost:8080/sse");

        // Listener para o evento específico que configuramos no backend
        eventSource.addEventListener('container-status', function (event) {
            try {
                const containers = JSON.parse(event.data);

                if (containers && containers.length > 0) {
                    loadingMessage.style.display = 'none';

                    containerGrid.innerHTML = "";

                    containers.forEach(container => {
                        // Verifica se os valores existem antes de calcular
                        const cpuPercent = container.maxCpuUsage > 0
                            ? (container.cpuUsage / container.maxCpuUsage) * 100
                            : 0;
                        const ramPercent = container.maxRamUsage > 0
                            ? (container.ramUsage / container.maxRamUsage) * 100
                            : 0;

                        const card = document.createElement("div");
                        card.className = "card";
                        card.id = `card-${container.id}`;
                        card.innerHTML = `
                            <h2>${container.nome || 'Sem nome'} (${container.id.substring(0, 12) || 'N/A'})</h2>
                            <p><strong>Imagem:</strong> ${container.imagem || 'N/A'}</p>
                            <p><strong>Porta:</strong> ${container.porta || 'N/A'}</p>
                            <p><strong>Status:</strong> <span class="${container.ativo ? 'ativo' : 'inativo'}">${container.ativo ? 'Ativo' : 'Inativo'}</span></p>

                            <p class="label">Uso de CPU: ${container.cpuUsage ? container.cpuUsage.toFixed(2) : '0'}%</p>
                            <div class="progress-bar">
                                <div class="fill" style="width: ${cpuPercent}%;"></div>
                            </div>

                            <p class="label">Uso de RAM: ${container.ramUsage ? container.ramUsage.toFixed(2) : '0'}MB</p>
                            <div class="progress-bar">
                                <div class="fill" style="width: ${ramPercent}%; background-color: #10b981;"></div>
                            </div>

                            <p><strong>Réplicas:</strong> ${container.minReplica || 0} - ${container.maxReplica || 0}</p>
                            <p><strong>Última leitura:</strong> ${container.horarioLeitura ? formatHoraMinutoSegundo(container.horarioLeitura) : 'N/A'}</p>

                            <button onclick="handleStopContainerClick('${container.id}')" style="background-color: red">Stop</button>
                            <button onclick="handleStopContainerBruteForceClick('${container.id}')" style="background-color: orangered">Stop Brute Force ⚠️</button>
                            <button onclick="handleStartContainerClick('${container.id}')" style="background-color: green">Start</button>
                        `;

                        containerGrid.appendChild(card);
                    });
                } else {
                    loadingMessage.textContent = "Nenhum container em execução";
                }
            } catch (error) {
                console.error("Erro ao processar dados:", error);
                showError("Erro ao processar os dados recebidos do servidor.");
            }
        });

        eventSource.onerror = function (error) {
            console.error("Erro na conexão SSE:", error);
            showError("Erro na conexão com o servidor. Tentando reconectar...");

            // Fecha a conexão atual
            eventSource.close();

            // Tenta reconectar após 5 segundos
            setTimeout(connectSSE, 5000);
        };
    }

    // Inicia a conexão quando a página carrega
    window.addEventListener('DOMContentLoaded', connectSSE);
</script>

</body>
</html>
